---
title: 리눅스 웹 서버로 파이선 실행하기 - 아파치
date: 2020-01-24 10:20
categories:
- [프로그래밍, 리눅스]
hidden: true
---

## 상황
* [mp4를 gif 형태로 바꿔주는 사이트](https://ezgif.com/video-to-gif)가 있다.
* 이런 사이트처럼 파일, 혹은 쿼리문을 받고 그걸 가지고 리눅스 서버에서 프로그래밍을 통해 결과물을 다운로드 링크로 제공하고자 한다.
* 웹 서버로 파이선을 실행하려면 아파치와 파이선을 연결하는 cgi를 활용하면 된다.

## 구현
* 이 포스트에서는 다음을 구현한다.
1. 웹 페이지를 하나 만든다. 웹 페이지에는 숫자를 입력할 수 있는 두 textbox와 send 버튼이 있다.
2. 숫자 2개를 넣고 send를 누르면, 숫자의 합이 적힌 txt 파일을 만든다.
3. 해당 파일을 다운로드할 수 있는 하이퍼링크를 페이지에 띄워준다.

## 설치 및 세팅
```bash
sudo apt-get install apache2 # 웹 서버가 필요하다.
```

```bash
sudo vi /etc/apache2/sites-enabled/000-default # 설정 파일을 연다.
```

설정 파일에서 아래 내용을 추가한다.
```bash
<Directory /var/www>
    Order allow,deny
    allow from all
    Options +ExecCGI # 이 부분 새로 추가
    AddHandler cgi-script .cgi .py # 이 부분 새로 추가
</Directory>
```

## 사용법
* 아래 두 파일을 만든다.
```html
<!-- index.html -->
<!-- /var/www/index.html -->
<!doctype>
<html>
<head>
</head>
<body>

<form name="form" method="get" action="http://localhost/plus.py">
<p>
num_1	: <input type="text" name="num_1">
num_2	: <input type="text" name="num_2">
<input type="submit" value="send">
</p>
</form>

</body>
</html>
```

```python
#!/usr/bin/python3
import cgi
# cgitb는 CGI 프로그래밍시 디버깅을 위한 모듈로, cgitb.enable() 할 경우 런타임 에러를 웹브라우저로 전송한다
# cgitb.enable() 하지 않은 상태로 실행 중 오류가 발생한 경우 웹서버는 클라이언트에게 HTTP 응답코드 500을 전송한다
import cgitb
cgitb.enable()

# HTTP 규격에서, 헤더 전송 이후에는 반드시 줄바꿈을 하게 되어있으므로 마지막에 \r\n을 전송한다
# 마지막에 \r\n을 전송하지 않으면 브라우저 측에서 오류가 발생한다
print("Content-type: text/html\r\n")


print('<html>')
print('<body>')

args = cgi.FieldStorage()

if "num_1" not in args or "num_2" not in args:
    print("Error")
else:
    sum = int(args["num_2"].value) + int(args["num_2"].value)
    sum = str(sum)

    with open("result.txt","w") as f:
        f.write(sum)

    print("<a href=\"http://108.160.135.200/result.txt\" download>result</a>")

print('</body>')
print('</html>')

```

## 문제 해결
1. 파이썬이 실행되지 않고 raw text로 접근되는 경우
   1. print("hello")라 적었으면 hello라는 내용이 있는 페이지를 보여줘야 하는데, print("hello")가 그대로 노출된다.
   2. 이는 아파치에서 cgi를 사용하도록 설정하지 않아서 그렇다. 아래 아파치에서 cgi 사용하기 링크를 참고한다.
1. permission denied 에러 (End of script output before headers 에러)
   1. nano /var/log/apache2/error.log 로 우분투의 아파치2 에러 로그로 간다.
   2. End of script output before headers 라는 에러 로그가 남아있다.
   3. 이를 해결하려면 파이선 파일 첫 줄에 #!/usr/bin/python3를 입력하면 된다. #!/usr/bin/python까지만 입력해놓고 찾아보다가 python3을 입력해야 한다는 걸 깨달았다.
1. Internal server error
   1. 내 경우는 권한 문제였다.
   2. chmod 777 plus.py
2. 파이선 with open의 권한 문제
   1. 상위 폴더(/var/www/html)에 권한을 주면 된다.
   2. chmod 777 /var/www/html
## 참고자료
* [아파치에서 cgi 사용하기](https://jpak.tistory.com/21)
* [서버의 파일을 어떻게 다운로드 가능한 링크로 만드나요?](https://stackoverflow.com/questions/10956587/how-to-create-a-downloadable-public-link-for-files-on-server)
* [파이썬3로 CGI 이용하기](https://parksk.tistory.com/120)
* [아파치2 에러 로그 위치](https://unikys.tistory.com/248)
* [파이선 쓰기 에러](https://redapply.tistory.com/entry/PermissionErrorErrno13-Permission-denied-%EC%9A%B0%EB%B6%84%ED%88%AC-%EC%97%90%EB%9F%AC%EC%8B%9C)
